<?xml version='1.0' encoding='windows-1252'?>
<Wix xmlns='http://schemas.microsoft.com/wix/2006/wi'>
    <Product Id='*' Name='MapFlow' UpgradeCode='0392650E-1608-4122-8232-024564879201' Manufacturer='MapFlow Contributors' Language='1033' Codepage='1252' Version='0.1.0'>
        <Package Id='*' Keywords='Installer' Description='MapFlow - Open Source VJ Projection Mapping Software' Manufacturer='MapFlow Contributors' InstallerVersion='450' Languages='1033' Compressed='yes' InstallScope='perMachine' SummaryCodepage='1252' Platform='x64'/>
        <MajorUpgrade Schedule='afterInstallInitialize' DowngradeErrorMessage='A newer version of [ProductName] is already installed. Setup will now exit.' />
        <Media Id='1' Cabinet='media1.cab' EmbedCab='yes' DiskPrompt='CD-ROM #1' />
        <Property Id='DiskPrompt' Value='MapFlow Installation [1]' />

        <Directory Id='TARGETDIR' Name='SourceDir'>
            <Directory Id='ProgramFiles64Folder'>
                <Directory Id='INSTALLFOLDER' Name='MapFlow'>
                    <!-- Main executable component -->
                    <Component Id='MainExecutable' Guid='*' Win64='yes'>
                        <File Id='MapFlowEXE' Name='MapFlow.exe' Source='$(var.CargoTargetBinDir)\MapFlow.exe' KeyPath='yes'>
                            <Shortcut Id='desktopMapFlow' Directory='DesktopFolder' Name='MapFlow' WorkingDirectory='INSTALLFOLDER' Icon='MapFlowIcon.exe' IconIndex='0' />
                        </File>
                    </Component>

                    <!-- Component to remove the installation folder on uninstall -->
                    <Component Id="CleanupMainApplicationFolder" Guid="*" Win64="yes">
                        <RegistryValue Root="HKCU" Key="Software\[Manufacturer]\[ProductName]" Name="Installed" Type="integer" Value="1" KeyPath="yes" />
                        <RemoveFolder Id="INSTALLFOLDER" On="uninstall" />
                    </Component>
                </Directory>
            </Directory>
            <Directory Id="ProgramMenuFolder" Name="Programs">
                <Directory Id="ProgramMenuDir" Name="MapFlow">
                    <!-- Component for the Start Menu shortcut -->
                    <Component Id="ApplicationShortcut" Guid="*" Win64="yes">
                        <Shortcut Id="ApplicationStartMenuShortcut"
                                  Name="MapFlow"
                                  Description="MapFlow VJ Software"
                                  Target="[#MapFlowEXE]"
                                  WorkingDirectory="INSTALLFOLDER"
                                  Icon="MapFlowIcon.exe" />
                        <RemoveFolder Id="ProgramMenuDir" On="uninstall" />
                        <RegistryValue Root="HKCU" Key="Software\[Manufacturer]\[ProductName]" Name="StartMenuShortcut" Type="integer" Value="1" KeyPath="yes" />
                    </Component>
                </Directory>
            </Directory>
            <Directory Id="DesktopFolder" Name="Desktop" />

            <!-- Directory for Visual C++ Redistributable Merge Modules -->
            <Directory Id="VCRedist" Name="VCRedist">
                <Merge Id="VCRedistMerge" SourceFile="$(var.VCRedistPath)\Microsoft_VC143_CRT_x64.msm" DiskId="1" Language="0" />
            </Directory>
        </Directory>

        <!-- Component group for FFmpeg DLLs -->
        <DirectoryRef Id="INSTALLFOLDER">
            <ComponentGroup Id="FFmpegDlls" Directory="INSTALLFOLDER">
                <Component Guid="*" Win64="yes">
                    <File Source="$(var.CargoTargetBinDir)\avcodec-60.dll" KeyPath="yes" />
                </Component>
                <Component Guid="*" Win64="yes">
                    <File Source="$(var.CargoTargetBinDir)\avformat-60.dll" KeyPath="yes" />
                </Component>
                <Component Guid="*" Win64="yes">
                    <File Source="$(var.CargoTargetBinDir)\avutil-58.dll" KeyPath="yes" />
                </Component>
                <Component Guid="*" Win64="yes">
                    <File Source="$(var.CargoTargetBinDir)\swresample-4.dll" KeyPath="yes" />
                </Component>
                <Component Guid="*" Win64="yes">
                    <File Source="$(var.CargoTargetBinDir)\swscale-7.dll" KeyPath="yes" />
                </Component>
            </ComponentGroup>
        </DirectoryRef>

        <!-- Feature definition -->
        <Feature Id='Complete' Level='1'>
            <ComponentRef Id='MainExecutable' />
            <ComponentRef Id="CleanupMainApplicationFolder" />
            <ComponentRef Id="ApplicationShortcut" />
            <ComponentGroupRef Id='FFmpegDlls' />
            <MergeRef Id="VCRedistMerge" />
        </Feature>

        <!-- UI and Properties -->
        <Icon Id="MapFlowIcon.exe" SourceFile="$(var.CargoTargetBinDir)\..\..\resources\app_icons\mapflow.ico" />
        <Property Id="ARPPRODUCTICON" Value="MapFlowIcon.exe" />

        <UI>
            <UIRef Id="WixUI_Minimal" />
        </UI>

        <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
        <WixVariable Id="WixUILicenseRtf" Value="$(var.CargoTargetBinDir)\..\..\crates\mapmap\wix\License.rtf" />
    </Product>
</Wix>

name: "CI-07: Post-Merge Automation"

on:
  pull_request:
    types: [closed]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to process'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  post-merge-actions:
    name: Post-Merge Actions
    runs-on: ubuntu-latest
    if: |
      (github.event.pull_request.merged == true && 
       (contains(github.event.pull_request.labels.*.name, 'jules-pr') || 
        contains(github.event.pull_request.body, 'Created by Jules'))) ||
      github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Get PR and Issue details
        id: get-details
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request?.number || 
                            parseInt('${{ github.event.inputs.pr_number }}' || '0');
            
            if (!prNumber) {
              core.info('No PR to process');
              core.setOutput('has_pr', 'false');
              return;
            }
            
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            core.setOutput('has_pr', 'true');
            core.setOutput('pr_number', prNumber);
            core.setOutput('pr_title', pr.title);
            core.setOutput('pr_body', pr.body || '');
            
            // Extract related issue number with multiple fallback strategies
            let issueNum = null;
            
            // Strategy 1: Check PR body for explicit "Closes #X" pattern (most reliable)
            const closesMatch = pr.body?.match(/(?:close|closes|closed|fix|fixes|fixed|resolve|resolves|resolved)\s*[:#]?\s*(\d+)/i);
            if (closesMatch) {
              issueNum = parseInt(closesMatch[1]);
              core.info(`âœ… Found issue from PR body "Closes #${issueNum}" pattern`);
            }
            
            // Strategy 2: Check PR title for issue reference
            if (!issueNum) {
              const titleMatch = pr.title?.match(/(?:#|issue\s*[:#]?\s*)(\d+)/i);
              if (titleMatch) {
                issueNum = parseInt(titleMatch[1]);
                core.info(`âœ… Found issue from PR title: #${issueNum}`);
              }
            }
            
            // Strategy 3: Check branch name for issue reference (e.g., "jules/issue-123")
            if (!issueNum) {
              const branchMatch = pr.head?.ref?.match(/(?:issue[-_]?|#)(\d+)/i);
              if (branchMatch) {
                issueNum = parseInt(branchMatch[1]);
                core.info(`âœ… Found issue from branch name '${pr.head?.ref}': #${issueNum}`);
              }
            }
            
            // Strategy 4: Check PR comments for issue references
            if (!issueNum) {
              try {
                const { data: comments } = await github.rest.issues.listComments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  per_page: 100
                });
                
                // Look for references in comments, especially from the workflow that created the PR
                for (const comment of comments) {
                  const commentMatch = comment.body?.match(/(?:issue|for)\s*[:#]?\s*(\d+)/i);
                  if (commentMatch) {
                    issueNum = parseInt(commentMatch[1]);
                    core.info(`âœ… Found issue from PR comment: #${issueNum}`);
                    break;
                  }
                }
              } catch (error) {
                core.warning(`Could not fetch PR comments: ${error.message}`);
              }
            }
            
            // Strategy 5: Check for issues that reference this PR
            if (!issueNum) {
              try {
                // Search for open issues that mention this PR number
                const query = `repo:${context.repo.owner}/${context.repo.repo} is:issue is:open ${prNumber}`;
                const { data: searchResults } = await github.rest.search.issuesAndPullRequests({
                  q: query,
                  per_page: 10
                });
                
                // Look for issues with jules-task label that mention this PR
                for (const issue of searchResults.items || []) {
                  const hasJulesLabel = issue.labels?.some(l => l.name === 'jules-task');
                  const mentionsPR = issue.body?.includes(`#${prNumber}`) || issue.title?.includes(`#${prNumber}`);
                  
                  if (hasJulesLabel && mentionsPR) {
                    issueNum = issue.number;
                    core.info(`âœ… Found related jules-task issue via search: #${issueNum}`);
                    break;
                  }
                }
                
                // If not found with jules-task, take any issue that mentions the PR
                if (!issueNum && searchResults.items && searchResults.items.length > 0) {
                  issueNum = searchResults.items[0].number;
                  core.info(`âœ… Found issue via search (mentions PR): #${issueNum}`);
                }
              } catch (error) {
                core.warning(`Could not search for related issues: ${error.message}`);
              }
            }
            
            if (issueNum) {
              core.setOutput('issue_number', issueNum);
              core.setOutput('has_issue', 'true');
              
              // Get issue details
              try {
                const { data: issue } = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNum
                });
                core.setOutput('issue_title', issue.title);
                core.setOutput('issue_body', issue.body || '');
                
                // Check if issue is closed
                if (issue.state === 'closed') {
                  core.setOutput('issue_already_closed', 'true');
                  core.info(`â„¹ï¸ Issue #${issueNum} is already closed`);
                } else {
                  core.setOutput('issue_already_closed', 'false');
                  core.info(`â„¹ï¸ Issue #${issueNum} is open and will be closed`);
                }
              } catch (error) {
                core.warning(`Could not fetch issue #${issueNum}: ${error.message}`);
                core.setOutput('has_issue', 'false');
              }
            } else {
              core.warning('âš ï¸ Could not find related issue number using any strategy');
              core.setOutput('has_issue', 'false');
              
              // Create a warning comment on the PR
              try {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: `âš ï¸ **Post-merge automation warning**: Could not automatically identify a related issue to close.\n\nIf this PR resolves an issue, please close it manually or ensure the PR body includes "Closes #123" in future PRs.`
                });
              } catch (commentError) {
                core.warning(`Could not add warning comment: ${commentError.message}`);
              }
            }

      - name: Close related issue
        id: close-issue
        if: steps.get-details.outputs.has_issue == 'true' && steps.get-details.outputs.issue_already_closed == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNum = parseInt('${{ steps.get-details.outputs.issue_number }}');
            const prNumber = parseInt('${{ steps.get-details.outputs.pr_number }}');
            
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNum,
              state: 'closed'
            });
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNum,
              body: `âœ… **Completed!** This issue has been resolved and merged in PR #${prNumber}.`
            });
            
            console.log(`âœ… Closed issue #${issueNum}`);

      - name: Update ROADMAP.md
        id: update-roadmap
        if: steps.get-details.outputs.has_issue == 'true'
        continue-on-error: true
        run: |
          set +e  # Don't exit on errors - we want to handle them gracefully
          
          ISSUE_NUM="${{ steps.get-details.outputs.issue_number }}"
          ISSUE_TITLE="${{ steps.get-details.outputs.issue_title }}"
          PR_NUM="${{ steps.get-details.outputs.pr_number }}"
          
          echo "ğŸ“ Attempting to update ROADMAP.md for issue #${ISSUE_NUM}"
          
          if [ ! -f "ROADMAP.md" ]; then
            echo "âš ï¸ ROADMAP.md not found - skipping roadmap update"
            echo "roadmap_updated=false" >> $GITHUB_OUTPUT
            echo "roadmap_skip_reason=file_not_found" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Create a backup for safety
          cp ROADMAP.md ROADMAP.md.backup
          CHANGES_MADE=false
          
          # Strategy 1: Update checkboxes with issue reference
          # Look for patterns like "- [ ] ... #123" or "- ğŸš§ ... #123"
          SEARCH_PATTERN="#${ISSUE_NUM}[^0-9]"
          if grep -q "${SEARCH_PATTERN}" ROADMAP.md || grep -q "#${ISSUE_NUM}\$" ROADMAP.md; then
            echo "âœ… Found issue #${ISSUE_NUM} in ROADMAP.md - updating status"
            
            # Update various checkbox patterns
            sed -i "s/- \[ \]\(.*#${ISSUE_NUM}\)\([^0-9].*\)/- [x]\1 (Completed in PR #${PR_NUM})\2/" ROADMAP.md
            sed -i "s/- \[ \]\(.*#${ISSUE_NUM}\)$/- [x]\1 (Completed in PR #${PR_NUM})/" ROADMAP.md
            sed -i "s/- ğŸš§\(.*#${ISSUE_NUM}\)\([^0-9].*\)/- âœ…\1 (Completed in PR #${PR_NUM})\2/" ROADMAP.md
            sed -i "s/- ğŸš§\(.*#${ISSUE_NUM}\)$/- âœ…\1 (Completed in PR #${PR_NUM})/" ROADMAP.md
            sed -i "s/- â¬œ\(.*#${ISSUE_NUM}\)\([^0-9].*\)/- âœ…\1 (Completed in PR #${PR_NUM})\2/" ROADMAP.md
            sed -i "s/- â¬œ\(.*#${ISSUE_NUM}\)$/- âœ…\1 (Completed in PR #${PR_NUM})/" ROADMAP.md
            
            CHANGES_MADE=true
          else
            echo "âš ï¸ Issue #${ISSUE_NUM} not explicitly referenced in ROADMAP.md"
          fi
          
          # Strategy 2: Add to "Recently Completed" section if it exists
          if ! $CHANGES_MADE; then
            DATE=$(date +%Y-%m-%d)
            
            # Try multiple section names
            for SECTION in "## Next Immediate Actions" "## Recently Completed" "## Completed Tasks" "# VjMapper"; do
              if grep -q "^${SECTION}" ROADMAP.md; then
                echo "âœ… Adding completion note to '${SECTION}' section"
                
                # Create completion entry using a temp file
                {
                  echo ""
                  echo "**Recently Completed (${DATE}):**"
                  echo "- âœ… Issue #${ISSUE_NUM}: ${ISSUE_TITLE} (PR #${PR_NUM})"
                  echo ""
                } > /tmp/completion_note.txt
                
                # Insert after the section header
                sed -i "/^${SECTION}/r /tmp/completion_note.txt" ROADMAP.md
                rm -f /tmp/completion_note.txt
                
                CHANGES_MADE=true
                break
              fi
            done
          fi
          
          # Strategy 3: Append to end of file if no suitable section found
          if ! $CHANGES_MADE; then
            echo "âš ï¸ No suitable section found - appending to end of ROADMAP.md"
            DATE=$(date +%Y-%m-%d)
            
            {
              echo ""
              echo "---"
              echo ""
              echo "## Recently Completed"
              echo ""
              echo "**${DATE}:**"
              echo "- âœ… Issue #${ISSUE_NUM}: ${ISSUE_TITLE} (PR #${PR_NUM})"
            } >> ROADMAP.md
            
            CHANGES_MADE=true
          fi
          
          # Check if file actually changed
          if diff -q ROADMAP.md ROADMAP.md.backup > /dev/null; then
            echo "â„¹ï¸ No changes made to ROADMAP.md"
            echo "roadmap_updated=false" >> $GITHUB_OUTPUT
            echo "roadmap_skip_reason=no_changes" >> $GITHUB_OUTPUT
          else
            echo "âœ… ROADMAP.md updated successfully"
            echo "roadmap_updated=true" >> $GITHUB_OUTPUT
          fi
          
          # Cleanup backup
          rm -f ROADMAP.md.backup
          
          exit 0

      - name: Commit ROADMAP changes
        if: steps.update-roadmap.outputs.roadmap_updated == 'true'
        continue-on-error: true
        run: |
          set +e  # Don't exit on errors
          
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          
          if ! git diff --quiet ROADMAP.md; then
            echo "ğŸ“ Committing ROADMAP.md changes..."
            git add ROADMAP.md
            
            if git commit -m "docs: Update ROADMAP.md - completed issue #${{ steps.get-details.outputs.issue_number }}"; then
              echo "âœ… Changes committed"
              
              # Try to push with retry logic
              MAX_RETRIES=3
              RETRY_COUNT=0
              
              while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
                if git push; then
                  echo "âœ… ROADMAP.md committed and pushed successfully"
                  exit 0
                else
                  RETRY_COUNT=$((RETRY_COUNT + 1))
                  if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                    echo "âš ï¸ Push failed, retrying ($RETRY_COUNT/$MAX_RETRIES)..."
                    sleep 2
                    # Use the default branch from the repository
                    BASE_BRANCH="${{ github.event.repository.default_branch || 'main' }}"
                    git pull --rebase origin "$BASE_BRANCH" || true
                  else
                    echo "âŒ Failed to push after $MAX_RETRIES attempts"
                    echo "Manual intervention may be required to push ROADMAP.md changes"
                    exit 1
                  fi
                fi
              done
            else
              echo "âŒ Failed to commit changes"
              exit 1
            fi
          else
            echo "â„¹ï¸ No changes to ROADMAP.md to commit"
          fi

      - name: Add summary comment to PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ steps.get-details.outputs.pr_number }}');
            const hasIssue = '${{ steps.get-details.outputs.has_issue }}' === 'true';
            const issueNumber = '${{ steps.get-details.outputs.issue_number }}';
            const roadmapUpdated = '${{ steps.update-roadmap.outputs.roadmap_updated }}' === 'true';
            const roadmapSkipReason = '${{ steps.update-roadmap.outputs.roadmap_skip_reason }}';
            
            if (!prNumber) return;
            
            let summary = '## ğŸ“ Post-Merge Automation Summary\n\n';
            
            if (hasIssue && issueNumber) {
              summary += `âœ… **Issue #${issueNumber} closed**\n`;
            } else {
              summary += `âš ï¸ **No related issue found** - Could not automatically close an issue\n`;
            }
            
            if (roadmapUpdated) {
              summary += `âœ… **ROADMAP.md updated** - Marked task as completed\n`;
            } else if (roadmapSkipReason === 'file_not_found') {
              summary += `â„¹ï¸ **ROADMAP.md not found** - Skipped roadmap update\n`;
            } else if (roadmapSkipReason === 'no_changes') {
              summary += `â„¹ï¸ **ROADMAP.md unchanged** - No updates needed\n`;
            } else {
              summary += `âš ï¸ **ROADMAP.md not updated** - Update may be needed manually\n`;
            }
            
            summary += '\n---\n*Automated by CI-07: Post-Merge Automation*';
            
            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: summary
              });
            } catch (error) {
              console.error('Failed to add summary comment:', error.message);
            }

      - name: Trigger next Jules session
        id: trigger-next
        uses: actions/github-script@v7
        with:
          script: |
            console.log('ğŸ”„ Triggering CI-04 for next Jules task...');
            
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'CI-04_session-trigger.yml',
                ref: 'main'
              });
              
              console.log('âœ… CI-04 triggered successfully');
              core.setOutput('triggered', 'true');
            } catch (error) {
              console.error('âŒ Failed to trigger CI-04:', error.message);
              core.setOutput('triggered', 'false');
            }

      - name: Summary
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ CI-07: Post-Merge Automation completed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "PR Number: ${{ steps.get-details.outputs.pr_number }}"
          echo "Issue Number: ${{ steps.get-details.outputs.issue_number }}"
          echo "Issue Closed: ${{ steps.close-issue.conclusion }}"
          echo "ROADMAP Updated: ${{ steps.update-roadmap.outputs.roadmap_updated }}"
          echo "Next Session Triggered: ${{ steps.trigger-next.outputs.triggered }}"
          echo ""

name: "CI-04: Session Trigger"

on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to trigger Jules session for (leave empty to process all open jules-task issues)'
        required: false
        type: string

permissions:
  issues: write
  contents: read

jobs:
  trigger-jules-session:
    name: Create Jules Session
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'issues' &&
       ((github.event.action == 'labeled' && github.event.label. name == 'jules-task') ||
        (github.event. action == 'opened' && contains(github.event.issue.labels.*.name, 'jules-task')))) ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Resolve issue(s) and validate label(s)
        id: get-issues
        uses: actions/github-script@v7
        with:
          script: |
            const MAX_PER_PAGE = 100;

            const getIssueFromContext = async () => {
              if (context.payload. issue) return context.payload.issue.number;
              if (context.eventName === 'workflow_dispatch' && context.payload.inputs && context.payload.inputs.issue_number) {
                const n = parseInt(context.payload.inputs.issue_number, 10);
                if (!isNaN(n)) return n;
              }
              return null;
            };

            const singleIssue = await getIssueFromContext();

            if (singleIssue) {
              const { data: issue } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: singleIssue
              });

              const labels = (issue.labels || []).map(l => (typeof l === 'string' ? l : l.name));
              if (!labels.includes('jules-task') || issue.state === 'closed') {
                core.info(`â­ï¸ Issue #${singleIssue} not applicable (missing label or closed).`);
                core. setOutput('has_issue', 'false');
                return;
              }

              core.info(`ğŸ¯ Will process single Issue #${singleIssue}`);
              core.setOutput('has_issue', 'true');
              core.setOutput('issue_numbers', `${singleIssue}`);
              return;
            }

            if (context.eventName === 'workflow_dispatch') {
              core.info('No issue_number input; listing open issues with label "jules-task"...');
              const issues = [];
              let page = 1;
              while (true) {
                const { data } = await github.rest.issues. listForRepo({
                  owner: context.repo.owner,
                  repo: context.repo. repo,
                  labels: 'jules-task',
                  state: 'open',
                  per_page: MAX_PER_PAGE,
                  page
                });
                if (!data || data.length === 0) break;
                for (const it of data) {
                  if (it.pull_request) continue;
                  issues.push(it.number);
                }
                if (data.length < MAX_PER_PAGE) break;
                page++;
              }

              if (issues.length === 0) {
                core.info('â­ï¸ No open issues with label "jules-task" found.');
                core.setOutput('has_issue', 'false');
                return;
              }

              core.info(`ğŸ¯ Found ${issues.length} issue(s) to process: ${issues.join(', ')}`);
              core.setOutput('has_issue', 'true');
              core.setOutput('issue_numbers', issues.join(','));
              return;
            }

            core.info('No issue information in workflow context â€” nothing to do.');
            core.setOutput('has_issue', 'false');

      - name: Check JULES_API_KEY secret
        id: check-key
        if: steps.get-issues.outputs.has_issue == 'true'
        run: |
          if [ -n "${{ secrets.JULES_API_KEY }}" ]; then
            echo "has_key=true" >> $GITHUB_OUTPUT
            echo "âœ… JULES_API_KEY is configured"
          else
            echo "has_key=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ JULES_API_KEY is NOT configured"
          fi

      - name: Create Jules session(s) via Google Jules API
        id: create-sessions
        if: steps. get-issues.outputs.has_issue == 'true' && steps.check-key.outputs.has_key == 'true'
        uses: actions/github-script@v7
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        with:
          script: |
            if (!process.env.JULES_API_KEY) {
              core.setFailed('JULES_API_KEY not set');
              return;
            }

            const endpoint = 'https://jules.googleapis.com/v1alpha/sessions';
            const issuesCsv = '${{ steps.get-issues. outputs.issue_numbers }}';
            const issues = issuesCsv.split(',').map(s => s.trim()).filter(Boolean);

            let created = 0;
            for (const issueNumberRaw of issues) {
              const issueNumber = parseInt(issueNumberRaw, 10);
              try {
                const { data: issue } = await github. rest.issues.get({
                  owner: context.repo.owner,
                  repo: context. repo.repo,
                  issue_number: issueNumber
                });

                const title = (`Issue #${issueNumber}: ${issue.title || ''}`).slice(0, 200);
                const body = (issue.body || '').slice(0, 5000);
                const repoId = `${context.repo.owner}/${context.repo.repo}`;
                const sourceName = `sources/github/${repoId}`;

                const payload = {
                  prompt: `Issue #${issueNumber}: ${title}\n\n${body}`,
                  title: title,
                  sourceContext: {
                    source: sourceName,
                    githubRepoContext: {
                      startingBranch: 'main'
                    }
                  }
                };

                core.info(`Creating Jules session for issue #${issueNumber}`);
                core.info(`POST ${endpoint}`);
                core.info(`Source: ${sourceName}`);

                await github.rest.issues.createComment({
                  owner: context. repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: `ğŸ¤– **Jules Session Triggered** â€” Creating session for this issue... `
                });

                const res = await fetch(endpoint, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'X-Goog-Api-Key': process.env. JULES_API_KEY,
                    'Accept': 'application/json'
                  },
                  body: JSON.stringify(payload)
                });

                const text = await res.text();
                let json = null;
                try { json = JSON.parse(text); } catch {}

                if (! res.ok) {
                  core.error(`Jules API for issue #${issueNumber} failed: ${res.status} ${text. slice(0, 500)}`);
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    body: `âš ï¸ **Jules API Error** â€” Status ${res.status}.\n\n\`\`\`\n${text. slice(0, 800)}\n\`\`\`\n\nSee [workflow logs](${context.serverUrl}/${context.repo. owner}/${context.repo.repo}/actions/runs/${context.runId}). `
                  });
                  continue;
                }

                const sessionUrl = json?.url ?? null;
                const sessionName = json?.name ?? json?.id ?? null;
                let successBody = `âœ… **Jules Session Created**`;
                if (sessionName) successBody += `\n\nSession: \`${sessionName}\``;
                if (sessionUrl) successBody += `\n\nğŸ”— [Open Session](${sessionUrl})`;

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: successBody
                });

                created++;
                core.info(`âœ… Session created for issue #${issueNumber}`);
              } catch (err) {
                core.error(`Error processing issue #${issueNumberRaw}: ${err.message}`);
              }
            }

            core. info(`Total sessions created: ${created}/${issues.length}`);
            core.setOutput('created_count', String(created));

      - name: Notify missing JULES_API_KEY
        if: steps.get-issues. outputs.has_issue == 'true' && steps.check-key.outputs.has_key == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const issuesCsv = '${{ steps.get-issues.outputs.issue_numbers }}';
            const issues = issuesCsv.split(','). map(s => s.trim()). filter(Boolean);
            for (const issueNumberRaw of issues) {
              const issueNumber = parseInt(issueNumberRaw, 10);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `âš ï¸ **Jules integration not configured**\n\nRepository secret \`JULES_API_KEY\` is missing.\n\n**Setup:**\n1. Go to [jules.google.com](https://jules.google.com) â†’ Settings â†’ API\n2. Generate an API key\n3. Add it as repository secret \`JULES_API_KEY\`\n\nOr install the [Jules GitHub App](https://github.com/apps/jules). `
              });
            }

      - name: Log completion
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ CI-04: Session Trigger completed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "has_issue: ${{ steps.get-issues.outputs.has_issue }}"
          echo "issue_numbers: ${{ steps.get-issues.outputs.issue_numbers }}"
          echo "has_key: ${{ steps.check-key.outputs.has_key }}"
          echo "created_count: ${{ steps.create-sessions.outputs.created_count }}"
          echo ""

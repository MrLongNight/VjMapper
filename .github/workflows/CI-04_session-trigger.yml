name: "CI-04: Session Trigger"

on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to trigger Jules session for'
        required: false
        type: string

permissions:
  issues: write
  contents: write
  pull-requests: write

jobs:
  trigger-jules-session:
    name: Create Jules Session
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'issues' &&
       ((github.event.action == 'labeled' && github.event.label.name == 'jules-task') ||
        (github.event.action == 'opened' && contains(github.event.issue.labels.*.name, 'jules-task')))) ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get issue details
        id: get-issue
        uses: actions/github-script@v7
        with:
          script: |
            let issueNumber;
            if (context.eventName === 'workflow_dispatch' && context.payload.inputs && context.payload.inputs.issue_number) {
              issueNumber = parseInt(context.payload.inputs.issue_number, 10);
            } else if (context.payload.issue) {
              issueNumber = context.payload.issue.number;
            }

            if (!issueNumber) {
              console.log('âš ï¸  No issue number found in workflow context');
              core.setOutput('has_issue', 'false');
              return;
            }

            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });

            const hasJulesLabel = issue.labels.some(label => label.name === 'jules-task');
            if (!hasJulesLabel) {
              console.log(`â­ï¸  Issue #${issueNumber} doesn't have 'jules-task' label - skipping`);
              core.setOutput('has_issue', 'false');
              return;
            }

            if (issue.state === 'closed') {
              console.log(`â­ï¸  Issue #${issueNumber} is already closed - skipping`);
              core.setOutput('has_issue', 'false');
              return;
            }

            console.log(`\nğŸ¯ Processing Issue #${issueNumber}: ${issue.title}`);
            core.setOutput('has_issue', 'true');
            core.setOutput('issue_number', issueNumber);
            core.setOutput('issue_title', issue.title);
            core.setOutput('issue_body', issue.body || '');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `ğŸ¤– **Jules Session Triggered**\n\nA Jules session is being created for this issue.\n\n*Triggered by: ${context.workflow} workflow*`
            });

      - name: Check for Jules API Key
        id: check-key
        if: steps.get-issue.outputs.has_issue == 'true'
        run: |
          if [ -n "${{ secrets.JULES_API_KEY }}" ]; then
            echo "has_key=true" >> $GITHUB_OUTPUT
            echo "âœ… JULES_API_KEY secret is configured"
          else
            echo "has_key=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  JULES_API_KEY secret is not configured"
            echo "If you don't want to use the API, install the Jules GitHub App: https://github.com/apps/jules"
          fi

      # Trigger via official Jules GitHub Action
      - name: Trigger Jules session via official action
        id: trigger-jules
        if: steps.get-issue.outputs.has_issue == 'true' && steps.check-key.outputs.has_key == 'true'
        uses: google-labs-code/jules-action@v1
        with:
          prompt: |
            Issue #${{ steps.get-issue.outputs.issue_number }}: ${{ steps.get-issue.outputs.issue_title }}
            
            ${{ steps.get-issue.outputs.issue_body }}
          jules_api_key: ${{ secrets.JULES_API_KEY }}
          starting_branch: 'main'

      - name: Update issue with success message
        if: steps.get-issue.outputs.has_issue == 'true' && steps.check-key.outputs.has_key == 'true' && steps.trigger-jules.outcome == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = parseInt('${{ steps.get-issue.outputs.issue_number }}', 10);
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `âœ… **Jules Session Created Successfully**\n\nJules is now working on this issue using the official Jules GitHub Action.`
            });

      - name: Update issue with failure message
        if: steps.get-issue.outputs.has_issue == 'true' && steps.check-key.outputs.has_key == 'true' && steps.trigger-jules.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = parseInt('${{ steps.get-issue.outputs.issue_number }}', 10);
            const logsUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `âš ï¸ **Jules Session Creation Failed**\n\nThere was an error creating the Jules session. Check the [workflow logs](${logsUrl}) for details.`
            });

      - name: Log completion
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ Workflow completed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          if [ "${{ steps.check-key.outputs.has_key }}" = "true" ]; then
            echo "âœ… Jules session triggered via official Jules GitHub Action"
          else
            echo "âš ï¸  Jules API key not configured"
            echo ""
            echo "ğŸ“š Setup options:"
            echo "   1. Jules GitHub App (Recommended - No API key needed):"
            echo "      â†’ https://github.com/apps/jules"
            echo ""
            echo "   2. Jules API + GitHub Actions:"
            echo "      â†’ Set repository secret JULES_API_KEY"
            echo "      â†’ Get your API key from https://jules.google.com (Settings)"
            echo ""
            echo "   See: .github/JULES_API_SETUP.md for detailed instructions"
          fi
          echo "" 

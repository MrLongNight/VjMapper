name: "CI-04: Session Trigger"

on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to trigger Jules session for (leave empty to use the oldest open jules-task)'
        required: false
        type: string

permissions:
  issues: write
  contents: write
  pull-requests: write

jobs:
  trigger-jules-session:
    name: Create Jules Session & Open PR
    runs-on: ubuntu-latest

    concurrency:
      # Use repository-wide lock to ensure issues are processed sequentially (not in parallel)
      # This prevents multiple Jules sessions from running at the same time
      group: ci-04-jules-session-${{ github.repository }}
      cancel-in-progress: false

    if: |
      (github.event_name == 'issues' &&
       ((github.event.action == 'labeled' && github.event.label.name == 'jules-task') ||
        (github.event.action == 'opened' && contains(github.event.issue.labels.*.name, 'jules-task')))) ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Resolve the single issue to process (oldest open jules-task when no input)
        id: get-issue
        uses: actions/github-script@v7
        with:
          script: |
            const MAX_PER_PAGE = 100;

            const getIssueFromContext = () => {
              if (context.payload.issue) return context.payload.issue.number;
              if (context.eventName === 'workflow_dispatch' && context.payload.inputs && context.payload.inputs.issue_number) {
                const n = parseInt(context.payload.inputs.issue_number, 10);
                if (!isNaN(n)) return n;
              }
              return null;
            };

            const explicitIssue = getIssueFromContext();
            if (explicitIssue) {
              const { data: issue } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: explicitIssue
              });

              const labels = (issue.labels || []).map(l => (typeof l === 'string' ? l : l.name));
              if (!labels.includes('jules-task') || issue.state === 'closed') {
                core.info(`â­ï¸ Issue #${explicitIssue} not applicable (missing label or closed).`);
                core.setOutput('has_issue', 'false');
                core.setOutput('issue_number', '');
                return;
              }

              core.info(`ğŸ¯ Will process explicit Issue #${explicitIssue}`);
              core.setOutput('has_issue', 'true');
              core.setOutput('issue_number', String(explicitIssue));
              return;
            }

            if (context.eventName === 'workflow_dispatch') {
              core.info('No issue_number input; listing open issues with label "jules-task" and selecting oldest...');
              let page = 1;
              const candidates = [];
              while (true) {
                const { data } = await github.rest.issues.listForRepo({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  labels: 'jules-task',
                  state: 'open',
                  per_page: MAX_PER_PAGE,
                  page
                });
                if (!data || data.length === 0) break;
                for (const it of data) {
                  if (it.pull_request) continue;
                  candidates.push({ number: it.number, created_at: it.created_at });
                }
                if (data.length < MAX_PER_PAGE) break;
                page++;
              }

              if (candidates.length === 0) {
                core.info('â­ï¸ No open issues with label "jules-task" found.');
                core.setOutput('has_issue', 'false');
                core.setOutput('issue_number', '');
                return;
              }

              candidates.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
              const chosen = candidates[0];
              core.info(`ğŸ¯ Selected oldest issue: #${chosen.number} (created_at: ${chosen.created_at})`);
              core.setOutput('has_issue', 'true');
              core.setOutput('issue_number', String(chosen.number));
              return;
            }

            core.info('No issue information in workflow context â€” nothing to do.');
            core.setOutput('has_issue', 'false');
            core.setOutput('issue_number', '');

      - name: Check if Jules session already exists
        id: check-existing
        if: steps.get-issue.outputs.has_issue == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = parseInt('${{ steps.get-issue.outputs.issue_number }}', 10);
            
            // Get all comments on the issue
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            
            // Check if a Jules session was already triggered
            // Look for multiple patterns to be more robust
            const hasSession = comments.some(comment => 
              comment.body.includes('Jules Session Triggered') || 
              comment.body.includes('Jules session created') ||
              comment.body.includes('ğŸ¤– **Jules Session Triggered**') ||
              (comment.body.includes('Jules') && comment.body.includes('session') && 
               (comment.body.includes('created') || comment.body.includes('triggered')))
            );
            
            if (hasSession) {
              core.info(`â­ï¸ Jules session already exists for issue #${issueNumber} - skipping`);
              core.setOutput('has_existing', 'true');
            } else {
              core.info(`âœ… No existing Jules session found for issue #${issueNumber}`);
              core.setOutput('has_existing', 'false');
            }

      - name: Check JULES_API_KEY secret
        id: check-key
        if: steps.get-issue.outputs.has_issue == 'true' && steps.check-existing.outputs.has_existing == 'false'
        run: |
          if [ -n "${{ secrets.JULES_API_KEY }}" ]; then
            echo "has_key=true" >> $GITHUB_OUTPUT
            echo "âœ… JULES_API_KEY is configured"
          else
            echo "has_key=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ JULES_API_KEY is NOT configured"
          fi

      - name: Create Jules session (list sources -> create)
        id: create-session
        if: steps.get-issue.outputs.has_issue == 'true' && steps.check-existing.outputs.has_existing == 'false' && steps.check-key.outputs.has_key == 'true'
        uses: actions/github-script@v7
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        with:
          script: |
            const fetch = globalThis.fetch ?? (await import('node-fetch')).default;
            const issueNumber = parseInt('${{ steps.get-issue.outputs.issue_number }}', 10);

            if (!process.env.JULES_API_KEY) throw new Error('JULES_API_KEY not set');

            // Read issue to build payload
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });

            const title = (`Issue #${issueNumber}: ${issue.title || ''}`).slice(0, 200);
            const body = (issue.body || '').slice(0, 5000);
            const repoId = `${context.repo.owner}/${context.repo.repo}`;
            const guessedSource = `sources/github/${repoId}`;

            // Optional: try to find exact Jules source (best-effort)
            let sourceName = guessedSource;
            try {
              const listRes = await fetch('https://jules.googleapis.com/v1alpha/sources', {
                method: 'GET',
                headers: { 'X-Goog-Api-Key': process.env.JULES_API_KEY, 'Accept': 'application/json' }
              });
              if (listRes.ok) {
                const listJson = await listRes.json().catch(()=>null);
                if (listJson && Array.isArray(listJson.sources)) {
                  const found = listJson.sources.find(s => s.name === guessedSource || (s.name && s.name.includes(`/github/${repoId}`)));
                  if (found && found.name) sourceName = found.name;
                }
              } else {
                core.info(`Listing sources returned ${listRes.status} - using guessed source ${guessedSource}`);
              }
            } catch (e) {
              core.info('Could not list Jules sources, proceeding with guessed source.');
            }

            const endpoint = 'https://jules.googleapis.com/v1alpha/sessions';
            const payload = {
              prompt: `Issue #${issueNumber}: ${title}\n\n${body}`,
              title: title,
              sourceContext: {
                source: sourceName,
                githubRepoContext: { startingBranch: 'main' }
              }
            };

            core.info(`Creating Jules session for issue #${issueNumber} (POST ${endpoint})`);
            core.info(`Using source ${sourceName}`);

            const res = await fetch(endpoint, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-Goog-Api-Key': process.env.JULES_API_KEY,
                'Accept': 'application/json'
              },
              body: JSON.stringify(payload)
            });

            const text = await res.text();
            let json = null;
            try { json = JSON.parse(text); } catch {}

            if (!res.ok) {
              core.error(`Jules API returned ${res.status}: ${text.slice(0,1000)}`);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `âš ï¸ **Jules Session Creation Failed** â€” API returned status ${res.status}.\n\n\`\`\`\n${text.slice(0,1000)}\n\`\`\``
              });
              throw new Error(`Jules API error ${res.status}`);
            }

            core.info('âœ… Jules session created');
            const sessionUrl = json?.url ?? null;
            const sessionName = json?.name ?? json?.id ?? null;

            // Try to detect branch created by Jules / used for PR
            const possibleBranchFields = [
              json?.gitPush?.branch,
              json?.git?.branch,
              json?.pr?.branch,
              json?.pullRequest?.branch,
              json?.workspace?.branch,
              json?.session_branch,
              json?.branch,
              json?.githubRepoContext?.branch,
              json?.sourceContext?.githubRepoContext?.startingBranch // fallback (base)
            ].filter(Boolean);

            const sessionBranch = possibleBranchFields.length > 0 ? possibleBranchFields[0] : null;

            // Save outputs
            core.setOutput('session_url', sessionUrl ?? '');
            core.setOutput('session_name', sessionName ?? '');
            core.setOutput('session_branch', sessionBranch ?? '');

            // Comment start
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `ğŸ¤– **Jules Session Triggered** â€” Jules session created. ${sessionUrl ? `ğŸ”— ${sessionUrl}` : ''}`
            });

      - name: Create Pull Request from Jules branch (if branch found)
        id: create-pr
        if: steps.create-session.outputs.session_branch != ''
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = parseInt('${{ steps.get-issue.outputs.issue_number }}', 10);
            const sessionBranch = '${{ steps.create-session.outputs.session_branch }}';
            const sessionUrl = '${{ steps.create-session.outputs.session_url }}';
            const sessionName = '${{ steps.create-session.outputs.session_name }}';

            // get default branch for base
            const { data: repo } = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            const baseBranch = repo.default_branch || 'main';

            core.info(`Attempting to create PR from branch '${sessionBranch}' into base '${baseBranch}'`);

            try {
              const prTitle = sessionName ? `Jules: ${sessionName}` : `Jules session for issue #${issueNumber}`;
              const prBody = `Automated PR created for Jules session.\n\nIssue: #${issueNumber}\n\n${sessionUrl ? `Session: ${sessionUrl}\n\n` : ''}This PR was created by the CI workflow.`;

              // Create PR
              const { data: pr } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: prTitle,
                head: sessionBranch,
                base: baseBranch,
                body: prBody
              });

              core.info(`PR created: ${pr.html_url}`);
              // Comment PR link on issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `âœ… **PR created** from Jules branch: ${pr.html_url}`
              });

              core.setOutput('pr_url', pr.html_url);
              core.setOutput('pr_number', String(pr.number));
            } catch (err) {
              core.error('Failed to create PR: ' + err.message);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `âš ï¸ **Failed to create PR automatically**. Branch detected: \`${sessionBranch}\`. You may create a PR manually or check Jules session. Error: ${err.message}`
              });
              throw err;
            }

      - name: Notify no branch found (manual step required)
        if: steps.create-session.outputs.session_branch == ''
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = parseInt('${{ steps.get-issue.outputs.issue_number }}', 10);
            const sessionUrl = '${{ steps.create-session.outputs.session_url }}';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `âš ï¸ **Automated PR creation skipped** â€” Could not detect a branch from the Jules session. ${sessionUrl ? `Open the session: ${sessionUrl}\n\n` : ''}Please create a Pull Request for the branch Jules uses (or configure Jules to push to a named branch).`
            });

      - name: Notify existing session
        if: steps.get-issue.outputs.has_issue == 'true' && steps.check-existing.outputs.has_existing == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = parseInt('${{ steps.get-issue.outputs.issue_number }}', 10);
            core.info(`Skipping duplicate session creation for issue #${issueNumber}`);
            
            // Add a comment to inform users that a session already exists
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `â„¹ï¸ **Jules session already exists** â€” A Jules session was already triggered for this issue. Skipping duplicate creation to prevent conflicts.`
            });

      - name: Notify missing JULES_API_KEY
        if: steps.get-issue.outputs.has_issue == 'true' && steps.check-existing.outputs.has_existing == 'false' && steps.check-key.outputs.has_key == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = parseInt('${{ steps.get-issue.outputs.issue_number }}', 10);
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `âš ï¸ **Jules integration not configured** â€” Repository secret \`JULES_API_KEY\` is missing. Get a key at https://jules.google.com â†’ Settings â†’ API and add it as secret \`JULES_API_KEY\`. Alternatively install the Jules GitHub App.`
            });

      - name: Log completion
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ CI-04: Session Trigger completed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "has_issue: ${{ steps.get-issue.outputs.has_issue }}"
          echo "issue_number: ${{ steps.get-issue.outputs.issue_number }}"
          echo "has_existing: ${{ steps.check-existing.outputs.has_existing }}"
          echo "has_key: ${{ steps.check-key.outputs.has_key }}"
          echo "session_name: ${{ steps.create-session.outputs.session_name }}"
          echo "session_branch: ${{ steps.create-session.outputs.session_branch }}"
          echo "session_url: ${{ steps.create-session.outputs.session_url }}"
          echo "pr_url: ${{ steps.create-pr.outputs.pr_url }}"
          echo ""

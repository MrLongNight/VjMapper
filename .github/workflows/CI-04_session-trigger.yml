name: "CI-04: Session Trigger"

on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to trigger Jules session for'
        required: false
        type: string

permissions:
  issues: write
  contents: read

jobs:
  trigger-jules-session:
    name: Create Jules Session
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'issues' &&
       ((github.event.action == 'labeled' && github.event.label.name == 'jules-task') ||
        (github.event.action == 'opened' && contains(github.event.issue.labels.*.name, 'jules-task')))) ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Resolve issue number and validate label
        id: get-issue
        uses: actions/github-script@v7
        with:
          script: |
            let issueNumber;
            if (context.eventName === 'workflow_dispatch' && context.payload.inputs && context.payload.inputs.issue_number) {
              issueNumber = parseInt(context.payload.inputs.issue_number, 10);
            } else if (context.payload.issue) {
              issueNumber = context.payload.issue.number;
            }

            if (!issueNumber) {
              core.info('‚ö†Ô∏è No issue number found in workflow context.');
              core.setOutput('has_issue', 'false');
              return;
            }

            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });

            const labels = (issue.labels || []).map(l => (typeof l === 'string' ? l : l.name));
            if (!labels.includes('jules-task')) {
              core.info(`‚è≠Ô∏è Issue #${issueNumber} does not have label 'jules-task'.`);
              core.setOutput('has_issue', 'false');
              return;
            }

            if (issue.state === 'closed') {
              core.info(`‚è≠Ô∏è Issue #${issueNumber} is closed.`);
              core.setOutput('has_issue', 'false');
              return;
            }

            core.info(`üéØ Processing Issue #${issueNumber}: ${issue.title}`);
            core.setOutput('has_issue', 'true');
            core.setOutput('issue_number', issueNumber.toString());
            core.setOutput('issue_title', issue.title || '');
            core.setOutput('issue_body', issue.body || '');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `ü§ñ **Jules Session Triggered** ‚Äî Creating Jules session for this issue (triggered by workflow).`
            });

      - name: Ensure JULES_API_KEY secret present
        id: check-key
        if: steps.get-issue.outputs.has_issue == 'true'
        run: |
          if [ -n "${{ secrets.JULES_API_KEY }}" ]; then
            echo "has_key=true" >> $GITHUB_OUTPUT
            echo "‚úÖ JULES_API_KEY present"
          else
            echo "has_key=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è JULES_API_KEY missing"
          fi

      - name: Create Jules session (list sources -> create)
        id: create-session
        if: steps.get-issue.outputs.has_issue == 'true' && steps.check-key.outputs.has_key == 'true'
        uses: actions/github-script@v7
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        with:
          script: |
            const issueNumber = parseInt('${{ steps.get-issue.outputs.issue_number }}', 10);
            const issueTitle = `${{ steps.get-issue.outputs.issue_title }}`.slice(0,240);
            const issueBody = `${{ steps.get-issue.outputs.issue_body }}`.slice(0,5000);

            if (!process.env.JULES_API_KEY) throw new Error('JULES_API_KEY not set');

            const fetch = globalThis.fetch ?? (await import('node-fetch')).default;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const repoId = `${owner}/${repo}`;
            const guessedSource = `sources/github/${repoId}`;

            // 1) List sources to try to find an exact source name (preferred)
            core.info('Listing Jules sources to find matching GitHub repo source...');
            const listRes = await fetch('https://jules.googleapis.com/v1alpha/sources', {
              method: 'GET',
              headers: {
                'X-Goog-Api-Key': process.env.JULES_API_KEY,
                'Accept': 'application/json'
              }
            });

            let listJson = null;
            if (listRes.ok) {
              listJson = await listRes.json().catch(()=>null);
            } else {
              core.warning(`Listing sources returned ${listRes.status}. Will still try guessed source ${guessedSource}.`);
            }

            let sourceName = guessedSource;
            if (listJson && Array.isArray(listJson.sources)) {
              const found = listJson.sources.find(s => {
                if (!s.name) return false;
                // exact match or contains repo path
                return s.name === guessedSource || s.name.includes(`/github/${owner}/${repo}`);
              });
              if (found && found.name) {
                sourceName = found.name;
                core.info(`Found source: ${sourceName}`);
              } else {
                core.info(`No exact source found in list; using guessed source ${guessedSource}`);
              }
            } else {
              core.info('Could not parse sources list; falling back to guessed source.');
            }

            // 2) Create session
            const endpoint = 'https://jules.googleapis.com/v1alpha/sessions';
            const payload = {
              prompt: `Issue #${issueNumber}: ${issueTitle}\n\n${issueBody}`,
              title: `Issue #${issueNumber}: ${issueTitle}`.slice(0,200),
              sourceContext: {
                source: sourceName,
                githubRepoContext: {
                  startingBranch: 'main'
                }
              }
            };

            core.info(`Creating Jules session via POST ${endpoint}`);
            core.info(`Using source: ${sourceName}`);

            const res = await fetch(endpoint, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-Goog-Api-Key': process.env.JULES_API_KEY,
                'Accept': 'application/json'
              },
              body: JSON.stringify(payload)
            });

            const text = await res.text();
            let json = null;
            try { json = JSON.parse(text); } catch {}

            if (!res.ok) {
              core.error(`Jules API error ${res.status}: ${text}`);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `‚ö†Ô∏è **Jules Session Creation Failed** ‚Äî API returned ${res.status}.\n\n\`\`\`\n${text.slice(0,1000)}\n\`\`\``
              });
              throw new Error(`Jules API returned ${res.status}`);
            }

            core.info('‚úÖ Jules session created');
            const sessionUrl = json?.url ?? null;
            const sessionName = json?.name ?? json?.id ?? null;

            let successBody = `‚úÖ **Jules Session Created Successfully**\n\nJules has been requested for this issue.`;
            if (sessionName) successBody += `\n\nSession: \`${sessionName}\``;
            if (sessionUrl) successBody += `\n\nüîó ${sessionUrl}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: successBody
            });

            core.setOutput('session_url', sessionUrl ?? '');
            core.setOutput('session_name', sessionName ?? '');

      - name: Notify missing JULES_API_KEY
        if: steps.get-issue.outputs.has_issue == 'true' && steps.check-key.outputs.has_key == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = parseInt('${{ steps.get-issue.outputs.issue_number }}', 10);
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `‚ö†Ô∏è **Jules integration not configured**\n\nSet repository secret \`JULES_API_KEY\` (get API key from https://jules.google.com ‚Üí Settings ‚Üí API) or install the Jules GitHub App: https://github.com/apps/jules`
            });

      - name: Log completion
        if: always()
        run: |
          echo "CI-04: Session Trigger completed"
          if [ "${{ steps.get-issue.outputs.has_issue }}" != "true" ]; then
            echo "No applicable issue or missing label 'jules-task'."
          else
            if [ "${{ steps.check-key.outputs.has_key }}" = "true" ]; then
              echo "Jules API called (see job logs)."
            else
              echo "JULES_API_KEY missing."
            fi
          fi

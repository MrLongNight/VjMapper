name: CI-09: Create Release (Windows ZIP)

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*.*.*'

jobs:
  windows-build:
    name: Windows-Build (Release)
    runs-on: windows-latest
    env:
      RUST_BACKTRACE: "1"
    steps:
      - name: Repository auschecken
        uses: actions/checkout@v4

      - name: Cache Cargo registry & index
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: windows-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: windows-cargo-

      - name: Installiere vcpkg (für ffmpeg)
        run: |
          git clone https://github.com/microsoft/vcpkg.git "%RUNNER_TEMP%\vcpkg"
          pushd "%RUNNER_TEMP%\vcpkg"
          bootstrap-vcpkg.bat
          popd
        shell: cmd

      - name: Setze VCPKG_ROOT und PATH
        run: |
          echo "VCPKG_ROOT=%RUNNER_TEMP%\\vcpkg" >> $GITHUB_ENV
          echo "%RUNNER_TEMP%\\vcpkg" >> $GITHUB_PATH
        shell: bash

      - name: Installiere ffmpeg via vcpkg (x64)
        run: |
          "%RUNNER_TEMP%\\vcpkg\\vcpkg.exe" install ffmpeg:x64-windows
        shell: cmd

      - name: Setup Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Installiere zusätzliche Build-Tools (Windows)
        run: |
          choco install -y visualstudio2019buildtools --noop
        if: always()
        shell: powershell

      - name: Verifiziere Build Tools
        run: |
           & "C:\Program Files (x86)\Microsoft Visual Studio\Installer\vswhere.exe" -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath
        shell: powershell

      - name: Build Release (cargo)
        run: |
          cargo build --release -p mapmap
        env:
          CARGO_TERM_COLOR: always

      - name: Prepare Distribution Folder
        if: success()
        run: |
          New-Item -ItemType Directory -Force -Path "dist"

          # Check if executable exists (might be .exe)
          if (Test-Path "target\release\VjMapper.exe") {
             Copy-Item -Path "target\release\VjMapper.exe" -Destination "dist\"
          } else {
             Write-Error "VjMapper.exe not found in target/release"
          }

          $vcpkgBin = "$env:VCPKG_ROOT\installed\x64-windows\bin"
          if (Test-Path "$vcpkgBin\*.dll") {
            Copy-Item -Path "$vcpkgBin\*.dll" -Destination "dist\"
          } else {
            Write-Warning "No DLLs found in vcpkg bin"
          }

          if (Test-Path "crates\mapmap\wix\License.rtf") {
             Copy-Item -Path "crates\mapmap\wix\License.rtf" -Destination "dist\"
          }

          if (Test-Path "README.md") {
             Copy-Item -Path "README.md" -Destination "dist\"
          }
        shell: powershell

      - name: Erstelle Release ZIP
        if: success()
        run: |
          mkdir -p artifacts
          Compress-Archive -Path "dist\*" -DestinationPath "artifacts\vjmapper-windows-x86_64.zip" -Force
        shell: powershell

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release-zip
          path: artifacts/vjmapper-windows-x86_64.zip
